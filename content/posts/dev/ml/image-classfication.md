---
title: "使用Pytorch训练一个图像分类器"
date: 2022-06-22T14:55:02+08:00
tags: ["pytorch", "ml", "image-classfication"]
summary: 训练一个图片分类器
draft: true
---

## 逻辑编程

当我们谈到编程的时候，往往都是指程序员根据需求和一些设定来设计组织业务**逻辑**、**流程**的这么一个过程。
侧重点是逻辑，流程，这么样的一个程序往往都是完成一些特定的任务，并且是在特定条件下才可以执行的程序，
从而得到一种输入数据到输出结果的固定映射。

## 数据编程

然而，机器学习正好相反，解题过程变成了：设定一个**模型**，这个模型里有很多**参数**，这些参数决定了这个模型 ***对于指定的输入，
将会做出怎样的输出。*** 

有了这个模型，再加上一系列 *标注* 了其对应的类别的 *数据*，称为**数据集**就可以建立训练过程了。
* 首先，我们依次把一系列数据中的的每一项给模型“看”，“告诉”模型这一项数据是什么类别，这个过程可以成为学习。
* 然后，经过这一次的学习，模型参数被**校准**一次，使用一些特定的办法，让我们可以知道调校后的模型和我们**设想**的模型**差别**有多大，来定义模型的**优劣程度**。
* 接着，我们需要一种**优化算法**，找到最佳参数，以最小化损失函数。
* 最后，再回到开头，循环这个过程。

{{< mermaid >}}
flowchart LR
    Data(获取数据) --> Update(校准模型)
    Update --> Check(验证模型)
    Check --> Data
{{< /mermaid >}}

这个过程叫做训练，我们会写一个程序来训练我们的模型，这个程序叫做训练程序，这样的过程可以看作 *以数据来编程*。这种类型的学习也叫监督学习，本文讨论的范畴都是监督学习。

## 基本概念

上述过程中，有几个概念，在此说明一下:

- **模型**：抽象的来说，就是表达输入输出之间的关系映射，也是这整个事情的目标。
具体点来说，可以说模型是一种特定的神经网络，比如说，常在计算机视觉方向应用的`ResNet`、`MobileNet`等。
结合上下文来说，这里说的模型指，一个能够输入任意图，对于训练目标类别进行判别，并输出这张图可能的类别判别结果的神经网路。

- 参数：参数是模型内部的设定，参数的变动会影响输入数据在模型中的流动过程，从而影响最终输出结果。


- **数据集**：一般分为**训练集**（train）、**验证集**（validation）和**测试集**（test），都是已标记的数据。训练集用来训练模型，进行调模型参数，验证集用于评估调过参的模型，测试集是不参与训练过程，模型完全没有见过的数据，用于评估模型性能以及正确率。训练集相当于是平时考试，不断在让模型适应更多的情况，验证集相当于是期末考试，对于平时考试成绩很好，到了期末考试成绩却不理想的这种情况，称为**过拟合**，也即是，训练集的表现不能推广到验证集。

- 标注：在监督学习中，训练数据是需要被正确标记的，这些数据会影响训练结果。

- 校准：指训练过程中，模型“看了”，人为标记好类别的图像，相当于人在告诉模型，这个图像是什么图。
这个图就是一个输入，图的类别是一个输出，然后根据这个输入和输出来调整模型的参数，使得模型可以适应这一个图像。

- **优劣程度**：每经过一次的学习，要对模型的学习成果打一个分儿，定义一个函数，来评价这一次学习之后，是进步了还是退步了，这个函数叫做**目标函数**，也叫做**损失函数**，函数值越低表示离模型设定的目标越接近。损失值用于指导后续的优化过程，目标是把损失降低。

- **优化算法**：用于在训练过程中，为模型找到最佳参数，以最小化损失函数。在深度学习中，大部分优化算法基于一个基本方法---**梯度下降**。梯度下降好比是在下山的过程中，寻找一条最快的下山路径。

- 学习率：学习训练这个过程是一步一步来的，每一步都根据优化函数调参，学习率会影响模型调参，学习率越高，调参幅度越大。


接下来看具体实现过程。

## 迁移学习

根据上述内容，要训练一个图像分类器，我们需要以首先准备好数据集，要训练好一个模型，数据集采集非常关键，不光要保证质量，还要保证数量。数量，是训练过程的一个关键，比如，[Fashion-MNIST]()数据集有6万张衣服裤子鞋子等10个类别的图片，[ImageNet]()数据集有超过1000万的图片，包括1000类的物体。

显然，这种量级的数据集的收集和标记都是非常消耗时间与金钱的。还好，要达成我们设定的目标，还有另一个方法，这一类方法叫做**迁移学习**，这种方法可以以经过大量数据训练后的模型作为起点，使用相对来说数量较少的数据集来接着训练，以实现将源数据集学到的知识，迁移到目标数据集，即使源数据集与目标数据集的目标无关，源数据集训练过的模型也可能会在目标数据集提取更通用的图像特征，这有助于识别边缘、纹理、形状和对象组合等。

{{< mermaid >}}
flowchart    
    OriginModel(源模型) -.-> TargetModel(目标模型)
    OriginData(源数据集) --> OriginModel
    TargetData(目标数据集) --> TargetModel
{{< /mermaid >}}

接下来我们选用 `resnext101_32x8d` 作为预训练模型，使用2200张已标记的建筑图片作为数据集进行训练，此案例标注的内容是，建筑图片中是否包含栅格构件，可以联系我获取已标注的数据集。

此数据集是文件夹形式，结构如下：

```bash
facade-reading-dataset/
└─ 栅格/
   ├─ 0/
   │  ├─ ... # n张不包含栅格的图片
   │  └─ *.jpg
   └─ 1/
      ├─ ... # n张包含栅格的图片
      └─ *.jpg
```

在Pytorch中加载这套数据集

```python
# -*- coding:utf-8 -*-

```